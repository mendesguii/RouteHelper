<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>RouteHelper Planner</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <script src="https://unpkg.com/htmx.org@1.9.2"></script>
    <style>
        /* Collapsible planner: hidden by default after submit, show on hover */
        .planner-wrapper.collapsed .box {
            opacity: 0;
            height: 0;
            overflow: hidden;
            padding: 0;
            margin-bottom: 0;
            transition: height 0.25s ease, opacity 0.25s ease, padding 0.25s ease, margin 0.25s ease;
        }
        .planner-wrapper.collapsed:hover .box {
            height: auto;
            opacity: 1;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
        }
        .planner-wrapper .hover-hint {
            display: none;
        }
        .planner-wrapper.collapsed .hover-hint {
            display: inline-block;
            color: #7a7a7a;
            font-size: 0.9rem;
            margin-left: 0.75rem;
        }
        /* ICAO suggestion dropdown */
        #origin-menu, #dest-menu { position: relative; }
        #origin-menu .dropdown, #dest-menu .dropdown { position: absolute; width: 100%; z-index: 20; }
        .dropdown-content { max-height: 220px; overflow: auto; }
        /* Dark mode theme overrides */
        html.dark, html.dark body { background-color: #121212; color: #e8e8e8; }
        html.dark .box { background-color: #1e1e1e; color: #e8e8e8; border-color: #2a2a2a; }
        html.dark .label, html.dark .title, html.dark .subtitle { color: #f0f0f0; }
        html.dark .input, html.dark .select select, html.dark .textarea { background-color: #222; color: #eee; border-color: #3a3a3a; }
        html.dark .textarea[readonly] { background-color: #1c1c1c; }
        html.dark .button.is-light { background-color: #2a2a2a; color: #e8e8e8; border-color: #3a3a3a; }
        html.dark .dropdown-content { background-color: #1e1e1e; border-color: #2a2a2a; }
        html.dark .dropdown-item { color: #e8e8e8; }
        html.dark .dropdown-item:hover { background-color: #2a2a2a; }
    html.dark .htmx-indicator { color: #aaa; }
    /* Strong/bold text should be readable in dark */
    html.dark strong { color: #ffffff; }
        /* Ensure pre/code blocks are dark-themed (e.g., METAR blocks) */
        html.dark pre, html.dark code { background-color: #1c1c1c; color: #e8e8e8; border-color: #2a2a2a; }
        html.dark .box pre { background-color: #1c1c1c; color: #e8e8e8; }
        /* Links visibility in dark */
        html.dark a { color: #8ab4f8; }
        /* Placeholder color */
        html.dark ::placeholder { color: #b5b5b5; opacity: 1; }
        /* Global loading overlay */
        #loading-overlay.htmx-indicator { display: none; }
        #loading-overlay {
            position: fixed; inset: 0; z-index: 9999;
            background: rgba(0,0,0,0.45);
            display: flex; align-items: center; justify-content: center;
        }
        .loading-card {
            background: #fff; color: #363636; border-radius: 8px; padding: 1.25rem 1.5rem; box-shadow: 0 8px 28px rgba(10,10,10,0.2);
            display: flex; align-items: center; gap: .75rem;
        }
        .spinner {
            width: 28px; height: 28px; border-radius: 50%; border: 3px solid #dbdbdb; border-top-color: #485fc7; animation: spin 0.9s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        /* Dark mode for loading card */
        html.dark .loading-card { background: #1e1e1e; color: #e8e8e8; box-shadow: 0 8px 28px rgba(0,0,0,0.6); }
        html.dark .spinner { border-color: #3a3a3a; border-top-color: #8ab4f8; }
        /* Force uppercase typing for ICAO fields */
        .uppercase-input { text-transform: uppercase; }
    </style>
</head>
<body>
<section class="section">
    <div class="container">
    <div id="planner" class="planner-wrapper">
    <div class="is-flex is-justify-content-space-between is-align-items-center" style="gap: .75rem;">
                <h1 class="title" style="margin-bottom: .5rem;">Route Planner <span>üó∫Ô∏è</span><span class="hover-hint">(hover to show)</span></h1>
                <div class="is-flex is-align-items-center" style="gap:.5rem;">
                    <div class="is-size-7" title="AIRAC {{ airac.cycle or 'unknown' }} ({{ airac.name or 'X-Plane' }})">
                        <span>AIRAC: <strong>{{ airac.cycle or 'unknown' }}</strong></span>
                        {% if airac.cycle and airac.is_current %}
                            <span style="color:#48c774;" aria-label="Up to date" title="Up to date">‚úî</span>
                        {% elif airac.cycle %}
                            <span style="color:#f14668;" aria-label="Out of date" title="Out of date">‚úñ</span>
                        {% else %}
                            <span style="color:#ffdd57;" aria-label="Missing" title="cycle.json not found">?</span>
                        {% endif %}
                    </div>
                    <button id="theme-toggle" class="button is-small is-light" type="button" title="Toggle dark mode" aria-label="Toggle dark mode">
                        <span id="theme-icon" aria-hidden="true">üåô</span>
                    </button>
                </div>
    </div>
    <form id="planner-form" hx-post="/plan" hx-target="#results" hx-swap="innerHTML" hx-indicator="#loading-overlay" class="box">
            <div class="columns">
                <div class="column">
                    <div class="field">
                        <label class="label">Origin ICAO</label>
                        <div class="control">
                <input id="origin-input" class="input uppercase-input" type="text" name="origin" autocomplete="off" required
                    hx-get="/icao_suggest" hx-trigger="keyup changed delay:150ms" 
                    hx-target="#origin-menu" hx-indicator="#origin-indicator"
                    hx-params="origin,mode,input_id,target_id,limit"
                    hx-vals='{"mode": "menu", "input_id": "origin-input", "target_id": "origin-menu", "limit": 12}'>
                <div id="origin-menu"></div>
                <span id="origin-indicator" class="htmx-indicator">Loading‚Ä¶</span>
                        </div>
                    </div>
                </div>
                <div class="column">
                    <div class="field">
                        <label class="label">Destination ICAO</label>
                        <div class="control">
                <input id="dest-input" class="input uppercase-input" type="text" name="dest" autocomplete="off" required
                    hx-get="/icao_suggest" hx-trigger="keyup changed delay:150ms"
                    hx-target="#dest-menu" hx-indicator="#dest-indicator"
                    hx-params="dest,mode,input_id,target_id,limit"
                    hx-vals='{"mode": "menu", "input_id": "dest-input", "target_id": "dest-menu", "limit": 12}'>
                <div id="dest-menu"></div>
                <span id="dest-indicator" class="htmx-indicator">Loading‚Ä¶</span>
                        </div>
                    </div>
                </div>
                <div class="column">
                    <div class="field">
                        <label class="label">Aircraft</label>
                        <div class="control">
                            <div class="select">
                                <select name="plane">
                                    {% for ac in aircraft_options %}
                                    <option value="{{ ac }}">{{ ac }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                {% set default_start = default_fl_start|int %}
                {% set default_end = default_fl_end|int %}
                <div class="column">
                    <div class="field">
                        <label class="label">FL Start</label>
                        <div class="control">
                            <div class="select is-fullwidth">
                                <select name="fl_start">
                                    {% for fl in range(100, 451, 10) %}
                                    <option value="{{ fl }}" {% if fl == default_start %}selected{% endif %}>FL{{ fl }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="column">
                    <div class="field">
                        <label class="label">FL End</label>
                        <div class="control">
                            <div class="select is-fullwidth">
                                <select name="fl_end">
                                    {% for fl in range(100, 451, 10) %}
                                    <option value="{{ fl }}" {% if fl == default_end %}selected{% endif %}>FL{{ fl }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="field is-grouped is-grouped-centered">
                <div class="control">
                    <button class="button is-primary" type="submit">Plan Route</button>
                </div>
            </div>
    </form>
    </div>
        <div id="results"></div>
    </div>
</section>
<!-- Global loading overlay shown while planning route -->
<div id="loading-overlay" class="htmx-indicator" role="status" aria-live="polite" aria-label="Loading" style="display:none;">
    <div class="loading-card">
        <div class="spinner" aria-hidden="true"></div>
        <div>
            <strong>Planning route‚Ä¶</strong>
            <div class="is-size-7">Please wait</div>
        </div>
    </div>
    </div>
<script>
    // When the plan completes (htmx afterOnLoad), collapse the planner wrapper
    document.body.addEventListener('htmx:afterOnLoad', function(ev) {
        var planner = document.getElementById('planner');
        if (planner && ev && ev.detail && ev.detail.target && ev.detail.target.id === 'results') {
            planner.classList.add('collapsed');
        }
    });
    // Show a global loading overlay during any htmx request
    (function(){
        var overlay = document.getElementById('loading-overlay');
        if (!overlay) return;
        document.body.addEventListener('htmx:beforeRequest', function(){ overlay.style.display = 'flex'; });
        document.body.addEventListener('htmx:afterRequest', function(){ overlay.style.display = 'none'; });
        document.body.addEventListener('htmx:responseError', function(){ overlay.style.display = 'none'; });
    })();
    // Keep planner collapsed after planning; reveal only on hover
    // Theme toggle with persistence
    (function(){
        var root = document.documentElement;
        var btn = document.getElementById('theme-toggle');
        var icon = document.getElementById('theme-icon');
        var mql = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)');
        function applyTheme(theme){
            var isDark = (theme === 'dark') || (theme === 'auto' && mql && mql.matches);
            if (isDark) root.classList.add('dark'); else root.classList.remove('dark');
            if (icon) icon.textContent = theme === 'auto' ? 'üñ•Ô∏è' : (isDark ? '‚òÄÔ∏è' : 'üåô');
        }
        function savedTheme(){ return localStorage.getItem('theme') || 'auto'; }
        function setTheme(theme){ localStorage.setItem('theme', theme); applyTheme(theme); }
        applyTheme(savedTheme());
        if (mql && mql.addEventListener) { mql.addEventListener('change', function(){ if (savedTheme()==='auto') applyTheme('auto'); }); }
        else if (mql && mql.addListener) { mql.addListener(function(){ if (savedTheme()==='auto') applyTheme('auto'); }); }
        if (btn) btn.addEventListener('click', function(){
            var current = savedTheme();
            var next = current === 'light' ? 'dark' : (current === 'dark' ? 'auto' : 'light');
            setTheme(next);
            btn.title = 'Theme: ' + next;
        });
        btn.title = 'Theme: ' + savedTheme();
    })();
    // Close suggestion menus on blur or Escape
    function closeMenu(id){ var el = document.getElementById(id); if (el) { var dd = el.querySelector('.dropdown'); if (dd) dd.classList.remove('is-active'); el.innerHTML = ''; } }
    ['origin-input', 'dest-input'].forEach(function(inputId){
        var el = document.getElementById(inputId);
        if (!el) return;
        // Force value to uppercase as the user types so submitted values are uppercase too
        el.addEventListener('input', function(){
            var start = this.selectionStart, end = this.selectionEnd;
            this.value = (this.value || '').toUpperCase();
            // Restore caret position where possible
            try { this.setSelectionRange(start, end); } catch(_) {}
        });
        el.addEventListener('blur', function(){ setTimeout(function(){ closeMenu(inputId.replace('-input','-menu')); }, 150); });
        el.addEventListener('keydown', function(ev){ if (ev.key === 'Escape') { closeMenu(inputId.replace('-input','-menu')); } });
    });
</script>
</body>
</html>
