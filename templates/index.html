{% extends 'base.html' %}
{% block title %}RouteHelper Planner{% endblock %}
{% block head_extra %}
    <style>
        /* Collapsible planner: hidden by default after submit, show on hover */
        .planner-wrapper.collapsed .box {
            opacity: 0;
            height: 0;
            overflow: hidden;
            padding: 0;
            margin-bottom: 0;
            transition: height 0.25s ease, opacity 0.25s ease, padding 0.25s ease, margin 0.25s ease;
        }
        .planner-wrapper.collapsed:hover .box {
            height: auto;
            opacity: 1;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
        }
        /* Keep planner open while user is typing/focused inside */
        .planner-wrapper.collapsed:focus-within .box {
            height: auto;
            opacity: 1;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
        }
        .planner-wrapper .hover-hint {
            display: none;
        }
        .planner-wrapper.collapsed .hover-hint {
            display: inline-block;
            color: #7a7a7a;
            font-size: 0.9rem;
            margin-left: 0.75rem;
        }
        /* ICAO suggestion dropdown */
        #origin-menu, #dest-menu { position: relative; }
        #origin-menu .dropdown, #dest-menu .dropdown { position: absolute; width: 100%; z-index: 20; }
        .dropdown-content { max-height: 220px; overflow: auto; }
        /* No custom dark/light overrides: use Bulma defaults */
        /* Global loading overlay */
        #loading-overlay.htmx-indicator { display: none; }
        #loading-overlay {
            position: fixed; inset: 0; z-index: 9999;
            background: rgba(0,0,0,0.45);
            display: flex; align-items: center; justify-content: center;
        }
        .loading-card {
            background: #fff; color: #363636; border-radius: 8px; padding: 1.25rem 1.5rem; box-shadow: 0 8px 28px rgba(10,10,10,0.2);
            display: flex; align-items: center; gap: .75rem;
        }
        .spinner {
            width: 28px; height: 28px; border-radius: 50%; border: 3px solid #dbdbdb; border-top-color: #485fc7; animation: spin 0.9s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    /* No dark-specific overrides for loading card */
        /* Force uppercase typing for ICAO fields */
        .uppercase-input { text-transform: uppercase; }
    </style>
{% endblock %}
{% block content %}
<section class="section">
    <div class="container">
    <div id="planner" class="planner-wrapper">
    <div class="is-flex is-justify-content-space-between is-align-items-center" style="gap: .75rem;">
                <h1 class="title" style="margin-bottom: .5rem;">Route Planner <span>üó∫Ô∏è</span><span class="hover-hint">(hover to show)</span></h1>
                <div class="is-flex is-align-items-center" style="gap:.5rem;">
                    <div class="is-size-7" title="AIRAC {{ airac.cycle or 'unknown' }} ({{ airac.name or 'X-Plane' }})">
                        <span>AIRAC: <strong>{{ airac.cycle or 'unknown' }}</strong></span>
                        {% if airac.cycle and airac.is_current %}
                            <span style="color:#48c774;" aria-label="Up to date" title="Up to date">‚úî</span>
                        {% elif airac.cycle %}
                            <span style="color:#f14668;" aria-label="Out of date" title="Out of date">‚úñ</span>
                        {% else %}
                            <span style="color:#ffdd57;" aria-label="Missing" title="cycle.json not found">?</span>
                        {% endif %}
                    </div>
                    <button id="theme-toggle" class="button is-small" type="button" title="Toggle theme" aria-label="Toggle theme">
                        <span id="theme-icon" aria-hidden="true">üåô</span>
                    </button>
                </div>
    </div>
    <form id="planner-form" hx-post="/plan" hx-target="#results" hx-swap="innerHTML" hx-indicator="#loading-overlay" class="box">
            <div class="columns">
                <div class="column">
                    <div class="field">
                        <label class="label">Origin ICAO</label>
                        <div class="control">
                <input id="origin-input" class="input uppercase-input" type="text" name="origin" autocomplete="off" required
                    hx-get="/icao_suggest" hx-trigger="keyup changed delay:150ms" 
                    hx-target="#origin-menu" hx-indicator="#origin-indicator"
                    hx-params="origin,mode,input_id,target_id,limit"
                    hx-vals='{"mode": "menu", "input_id": "origin-input", "target_id": "origin-menu", "limit": 12}'>
                <div id="origin-menu"></div>
                <span id="origin-indicator" class="htmx-indicator">Loading‚Ä¶</span>
                        </div>
                    </div>
                </div>
                <div class="column">
                    <div class="field">
                        <label class="label">Destination ICAO</label>
                        <div class="control">
                <input id="dest-input" class="input uppercase-input" type="text" name="dest" autocomplete="off" required
                    hx-get="/icao_suggest" hx-trigger="keyup changed delay:150ms"
                    hx-target="#dest-menu" hx-indicator="#dest-indicator"
                    hx-params="dest,mode,input_id,target_id,limit"
                    hx-vals='{"mode": "menu", "input_id": "dest-input", "target_id": "dest-menu", "limit": 12}'>
                <div id="dest-menu"></div>
                <span id="dest-indicator" class="htmx-indicator">Loading‚Ä¶</span>
                        </div>
                    </div>
                </div>
                <div class="column">
                    <div class="field">
                        <label class="label">Aircraft</label>
                        <div class="control">
                            <div class="select">
                                <select name="plane">
                                    {% for ac in aircraft_options %}
                                    <option value="{{ ac }}">{{ ac }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                {% set default_start = default_fl_start|int %}
                {% set default_end = default_fl_end|int %}
                <div class="column">
                    <div class="field">
                        <label class="label">FL Start</label>
                        <div class="control">
                            <div class="select is-fullwidth">
                                <select name="fl_start">
                                    {% for fl in range(100, 451, 10) %}
                                    <option value="{{ fl }}" {% if fl == default_start %}selected{% endif %}>FL{{ fl }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="column">
                    <div class="field">
                        <label class="label">FL End</label>
                        <div class="control">
                            <div class="select is-fullwidth">
                                <select name="fl_end">
                                    {% for fl in range(100, 451, 10) %}
                                    <option value="{{ fl }}" {% if fl == default_end %}selected{% endif %}>FL{{ fl }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="field is-grouped is-grouped-centered">
                <div class="control">
                    <button class="button is-primary" type="submit">Plan Route</button>
                </div>
            </div>
    </form>
    </div>
        <div id="results"></div>
    </div>
</section>
<!-- Global loading overlay shown while planning route -->
<div id="loading-overlay" class="htmx-indicator" role="status" aria-live="polite" aria-label="Loading" style="display:none;">
    <div class="loading-card">
        <div class="spinner" aria-hidden="true"></div>
        <div>
            <strong>Planning route‚Ä¶</strong>
            <div class="is-size-7">Please wait</div>
        </div>
    </div>
    </div>
<script>
    // When the plan completes (htmx afterOnLoad), collapse the planner wrapper
    document.body.addEventListener('htmx:afterOnLoad', function(ev) {
        var planner = document.getElementById('planner');
        if (planner && ev && ev.detail && ev.detail.target && ev.detail.target.id === 'results') {
            planner.classList.add('collapsed');
        }
    });
    // Show a global loading overlay during any htmx request
    (function(){
        var overlay = document.getElementById('loading-overlay');
        if (!overlay) return;
        document.body.addEventListener('htmx:beforeRequest', function(){ overlay.style.display = 'flex'; });
        document.body.addEventListener('htmx:afterRequest', function(){ overlay.style.display = 'none'; });
        document.body.addEventListener('htmx:responseError', function(){ overlay.style.display = 'none'; });
    })();
    // Keep planner collapsed after planning; reveal only on hover
    // Close suggestion menus on blur or Escape
    function closeMenu(id){ var el = document.getElementById(id); if (el) { var dd = el.querySelector('.dropdown'); if (dd) dd.classList.remove('is-active'); el.innerHTML = ''; } }
    ['origin-input', 'dest-input'].forEach(function(inputId){
        var el = document.getElementById(inputId);
        if (!el) return;
        // Force value to uppercase as the user types so submitted values are uppercase too
        el.addEventListener('input', function(){
            var start = this.selectionStart, end = this.selectionEnd;
            this.value = (this.value || '').toUpperCase();
            // Restore caret position where possible
            try { this.setSelectionRange(start, end); } catch(_) {}
        });
        el.addEventListener('blur', function(){ setTimeout(function(){ closeMenu(inputId.replace('-input','-menu')); }, 150); });
        el.addEventListener('keydown', function(ev){ if (ev.key === 'Escape') { closeMenu(inputId.replace('-input','-menu')); } });
    });
</script>
{% endblock %}
